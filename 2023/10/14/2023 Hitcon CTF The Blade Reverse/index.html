<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>2023 Hitcon CTF The Blade Reverse - Jsjsj</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="2023 Hitcon CTF The Blade Reverse - Jsjsj" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://jsjsj.top/2023/10/14/2023%20Hitcon%20CTF%20The%20Blade%20Reverse/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-10-14T13:55:12.000Z" />
  
  <meta property="og:article:author" content="Mr. Jsjsj" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 7.0.0-rc2"></head>
    <body
        data-color-scheme="Dark"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Jsjsj&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/tags">Tags</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/jsjsj1" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        

        
        <div class="date" id="date">
            <span>October</span>
            <span>14,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">2023 Hitcon CTF The Blade Reverse</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><strong>前言：很有意思一道Reverse题，在位移加密有很多巧妙方法，这里记录下做题的过程</strong></p>
<p>这道题学到了很多东西呜呜呜，本篇记录下调试当中的一些技巧方法和参照3cly师傅的博客一些加密的骚操作</p>
<p>此题是个rust 逆向题，是个socket类型的交互题，我们使用字符串定位的方法定位到关键部分，这里我定位到了如下代码位置（前部分找入口找到对应字符串直接交叉引用即可）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_rust_dealloc();</span><br><span class="line">        <span class="keyword">goto</span> LABEL_178;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x67616C66</span>:   <span class="comment">// flag</span></span><br><span class="line">    v18 = <span class="number">9LL</span>;</span><br><span class="line">    v19 = <span class="string">&quot;IncorrectCorrectError: portscan: too many argumentsnetcatError: netcat: too many argumentsError: netcat: invalid portError: netcat: no input file specifiedUnknown command &#x27;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v182 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v51 = seccomp_shell::shell::verify::h898bf5fa26dafbab(</span><br><span class="line">              input,                <span class="comment">// flag</span></span><br><span class="line">              *(_QWORD *)(v175 + <span class="number">24</span>),</span><br><span class="line">              *(_QWORD *)(v175 + <span class="number">40</span>));</span><br><span class="line">      v53 = v52;</span><br><span class="line">      <span class="keyword">if</span> ( v51 )</span><br><span class="line">        seccomp_shell::util::print_failed::h41a9d0b5672e2e2f(</span><br><span class="line">          <span class="string">&quot;IncorrectCorrectError: portscan: too many argumentsnetcatError: netcat: too many argumentsError: netcat: invalid portError: netcat: no input file specifiedUnknown command &#x27;&quot;</span>,</span><br><span class="line">          <span class="number">9LL</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>seccomp_shell::shell::verify::h898bf5fa26dafbab 它的传参就是我们要输出的字符串（flag) 这个函数就是我们要逆的主要函数</p>
<p>我们进到里面发现代码很多，这里我列出关键部分代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(dest, &amp;unk_62920, <span class="number">0x200</span>uLL);</span><br><span class="line">v52 = <span class="number">64LL</span>;</span><br><span class="line">v53 = (__int64 *)dest + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v54 = *(v53 - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v54 &gt; <span class="number">0x3F</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">  v55 = flag[v52 - <span class="number">1</span>];</span><br><span class="line">  flag[v52 - <span class="number">1</span>] = flag[v54];</span><br><span class="line">  flag[v54] = v55;</span><br><span class="line">  v56 = *v53;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)*v53 &gt; <span class="number">0x3F</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">  v57 = flag[v52 - <span class="number">2</span>];</span><br><span class="line">  flag[v52 - <span class="number">2</span>] = flag[v56];</span><br><span class="line">  flag[v56] = v57;</span><br><span class="line">  v53 += <span class="number">2</span>;</span><br><span class="line">  v52 -= <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v52 );</span><br></pre></td></tr></table></figure>

<p>我截取了最后的换位加密的代码，前面还有好几个这样的换位加密，但它换位加密的表在整个while循环一次下来都是固定的，在最外层的while循环里是256次，如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span> ( v52 );</span><br><span class="line">  v58 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v59 = (<span class="type">unsigned</span> __int8)flag[v58] + <span class="number">1</span>;</span><br><span class="line">    LOWORD(v51) = <span class="number">1</span>;</span><br><span class="line">    LOWORD(v52) = <span class="number">257</span>;</span><br><span class="line">    v60 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v62 = v52;</span><br><span class="line">      LOWORD(v52) = (<span class="type">unsigned</span> __int16)v52 / (<span class="type">unsigned</span> __int16)v59;</span><br><span class="line">      v61 = v62 % (<span class="type">unsigned</span> __int16)v59;</span><br><span class="line">      v63 = v51;</span><br><span class="line">      v51 = v60 - v51 * v52;</span><br><span class="line">      LODWORD(v52) = v59;</span><br><span class="line">      v59 = (<span class="type">unsigned</span> __int16)(v62 % (<span class="type">unsigned</span> __int16)v59);</span><br><span class="line">      v60 = v63;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v61 );</span><br><span class="line">    v64 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (__int16)v63 &gt; <span class="number">0</span> )</span><br><span class="line">      v64 = v63;</span><br><span class="line">    flag[v58] = ((<span class="type">unsigned</span> __int16)(v64 + ((__int16)v63 &gt;&gt; <span class="number">15</span>) - v63) / <span class="number">0x101</span>u</span><br><span class="line">               + v63</span><br><span class="line">               + ((<span class="type">unsigned</span> __int16)v63 &gt;&gt; <span class="number">15</span>)</span><br><span class="line">               + <span class="number">113</span>) ^ <span class="number">0x89</span>;</span><br><span class="line">    v52 = v58 + <span class="number">1</span>;</span><br><span class="line">    v58 = v52;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v52 != <span class="number">64</span> );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v8 != <span class="number">256</span> );</span><br></pre></td></tr></table></figure>

<p>在经历完换位加密后又进行了一次除取余的操作64次，这里猜测一次只能处理64个字节（其实就是64字节）通过这段加密将整个输入的字符串进行了一个除+取余等操作</p>
<p>经过逆向分析以上进行换位位移加密都是用的固定的索引，只要我们找到对应的索引进行逐个还原就可以了，在以上换位加密代码和第二次加密的行为也与用户输入值没有任何关系，我们可以找到加密前的密文和加密后的密文进行比较就可以了，用 00-ff 的映射（引用师傅的一句话逆向加密算法比较复杂，就找出 00-ff 的映射就行了 因为是按位加密的伐然后前面的几次打乱顺序由于是固定的表所以可以看成一次打乱顺序 找出索引交换的顺序即可）</p>
<p>生成 0~ff 的 hex 序列：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">256</span>, <span class="number">64</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytearray</span>(<span class="built_in">range</span>(i, i+<span class="number">64</span>)).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<p>这里先放这，我们测试的数据是flag 0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ{} 先把加密前的数据提取出来，我把断点下在了这个位置</p>
<p><img src="/images/re/1.png"></p>
<p>提取flag变量里的数据</p>
<p>数据是HfVl{qPcCYNMoRi6D7Jr}espOL3FhwdWAtTGZba4Ugjvnx1QkKE2IS9yuz5BX08m</p>
<p>这是打乱后的字符串，也就是在经历下面加密前的字符串</p>
<p>下面我们用上面hex序列获取加密后的数据，为什么要生成256，因为整个wile循环是256所以我们要生成256个字字节分别进行64个字节的处理，总共调4次即可</p>
<p>我把断点下在了如下的位置：</p>
<p><img src="/images/re/2.png"></p>
<p><img src="/images/re/3.png"></p>
<p><img src="/images/re/4.png"></p>
<p>我下了如图两个断点，一个是加密前（打乱后），另一个是整个执行完一次后的加密</p>
<p>我们动调的时候用idapython脚本去把flag变量值给改下，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前选中的地址</span></span><br><span class="line">current_address = idc.get_screen_ea()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取堆栈上的指针变量地址</span></span><br><span class="line">stack_pointer = <span class="number">0x556646C923E0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要写入的非常长的数据按小端序存储</span></span><br><span class="line">data = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐字节将数据按小端序写入指定地址</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">4</span>):</span><br><span class="line">    value = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[i:i+<span class="number">4</span>])[<span class="number">0</span>]  <span class="comment"># 小端序</span></span><br><span class="line">    idaapi.patch_dword(stack_pointer + i, value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果</span></span><br><span class="line">idaapi.msg(<span class="string">&quot;数据已按小端序写入堆栈地址: 0x&#123;:X&#125;\n&quot;</span>.<span class="built_in">format</span>(stack_pointer))</span><br></pre></td></tr></table></figure>

<p>f9运行到下面哪个断点提取的加密数据是</p>
<p>[0xFB, 0x7B, 0x4E, 0xBB, 0x51, 0x15, 0x8D, 0xDB, 0xB0, 0xAC, 0xA5, 0x8E, 0xAA, 0xB2, 0x60, 0xEB, 0x63, 0x5C, 0xDE, 0x42, 0x2B, 0xC6, 0xA6, 0x35, 0x30, 0x43, 0xD6, 0x5F, 0xBD, 0x24, 0xB1, 0xE3, 0x8C, 0xA7, 0xD5, 0x2A, 0x7C, 0x6D, 0x8B, 0x17, 0x9D, 0x83, 0xFE, 0x69, 0x10, 0x59, 0xA9, 0x9E, 0x0F, 0x1C, 0x66, 0x97, 0x5B, 0x61, 0xED, 0xAD, 0xE0, 0xDA, 0x27, 0x06, 0x25, 0xDC, 0x5E, 0xE7, 0x40, 0x41]</p>
<p>我们发现第一次提取到0x40前，因为一次加密只能处理64个字节，所以我们这里还要再进行3次处理剩余的序列，我们再在动调的时候把flag这个变量值改为0x40开始</p>
<p>第二次数据是4132D2D98FEEAF03933A00A2E1B3EC819FCA58B779FD3BA0020CCBA880C0164D2F75710A0439FFC19CABEFA4D8E214C26C641E6B7E992E090B86746AC42D4FF980</p>
<p>剩下再从80开始动调，直到00-255个数据加密完后就是我们动调后的加密密文</p>
<p>找到后，先还原下加密后的数据，这里参考了3cly师傅的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data: <span class="built_in">list</span>, table: <span class="built_in">dict</span></span>):</span><br><span class="line">    tmp=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        tmp.append(table[i])</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_order</span>(<span class="params">data:<span class="built_in">list</span>, table: <span class="built_in">list</span></span>):</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        tmp.append(data[table[i]])</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="comment">#get crypto table</span></span><br><span class="line">s0_255 = [<span class="number">0xFB</span>, <span class="number">0x7B</span>, <span class="number">0x4E</span>, <span class="number">0xBB</span>, <span class="number">0x51</span>, <span class="number">0x15</span>, <span class="number">0x8D</span>, <span class="number">0xDB</span>, <span class="number">0xB0</span>, <span class="number">0xAC</span>, <span class="number">0xA5</span>, <span class="number">0x8E</span>, <span class="number">0xAA</span>, <span class="number">0xB2</span>, <span class="number">0x60</span>, <span class="number">0xEB</span>, <span class="number">0x63</span>, <span class="number">0x5C</span>, <span class="number">0xDE</span>, <span class="number">0x42</span>, <span class="number">0x2B</span>, <span class="number">0xC6</span>, <span class="number">0xA6</span>, <span class="number">0x35</span>, <span class="number">0x30</span>, <span class="number">0x43</span>, <span class="number">0xD6</span>, <span class="number">0x5F</span>, <span class="number">0xBD</span>, <span class="number">0x24</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>, <span class="number">0x8C</span>, <span class="number">0xA7</span>, <span class="number">0xD5</span>, <span class="number">0x2A</span>, <span class="number">0x7C</span>, <span class="number">0x6D</span>, <span class="number">0x8B</span>, <span class="number">0x17</span>, <span class="number">0x9D</span>, <span class="number">0x83</span>, <span class="number">0xFE</span>, <span class="number">0x69</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0xA9</span>, <span class="number">0x9E</span>, <span class="number">0x0F</span>, <span class="number">0x1C</span>, <span class="number">0x66</span>, <span class="number">0x97</span>, <span class="number">0x5B</span>, <span class="number">0x61</span>, <span class="number">0xED</span>, <span class="number">0xAD</span>, <span class="number">0xE0</span>, <span class="number">0xDA</span>, <span class="number">0x27</span>, <span class="number">0x06</span>, <span class="number">0x25</span>, <span class="number">0xDC</span>, <span class="number">0x5E</span>, <span class="number">0xE7</span>,</span><br><span class="line">        <span class="number">0x41</span>, <span class="number">0x32</span>, <span class="number">0xD2</span>, <span class="number">0xD9</span>, <span class="number">0x8F</span>, <span class="number">0xEE</span>, <span class="number">0xAF</span>, <span class="number">0x03</span>, <span class="number">0x93</span>, <span class="number">0x3A</span>, <span class="number">0x00</span>, <span class="number">0xA2</span>, <span class="number">0xE1</span>, <span class="number">0xB3</span>, <span class="number">0xEC</span>, <span class="number">0x81</span>, <span class="number">0x9F</span>, <span class="number">0xCA</span>, <span class="number">0x58</span>, <span class="number">0xB7</span>, <span class="number">0x79</span>, <span class="number">0xFD</span>, <span class="number">0x3B</span>, <span class="number">0xA0</span>, <span class="number">0x02</span>, <span class="number">0x0C</span>, <span class="number">0xCB</span>, <span class="number">0xA8</span>, <span class="number">0x80</span>, <span class="number">0xC0</span>, <span class="number">0x16</span>, <span class="number">0x4D</span>, <span class="number">0x2F</span>, <span class="number">0x75</span>, <span class="number">0x71</span>, <span class="number">0x0A</span>, <span class="number">0x04</span>, <span class="number">0x39</span>, <span class="number">0xFF</span>, <span class="number">0xC1</span>, <span class="number">0x9C</span>, <span class="number">0xAB</span>, <span class="number">0xEF</span>, <span class="number">0xA4</span>, <span class="number">0xD8</span>, <span class="number">0xE2</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x6C</span>, <span class="number">0x64</span>, <span class="number">0x1E</span>, <span class="number">0x6B</span>, <span class="number">0x7E</span>, <span class="number">0x99</span>, <span class="number">0x2E</span>, <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0x86</span>, <span class="number">0x74</span>, <span class="number">0x6A</span>, <span class="number">0xC4</span>, <span class="number">0x2D</span>, <span class="number">0x4F</span>, <span class="number">0xF9</span>,</span><br><span class="line">        <span class="number">0xFA</span>, <span class="number">0x94</span>, <span class="number">0xB6</span>, <span class="number">0x1F</span>, <span class="number">0x89</span>, <span class="number">0x6F</span>, <span class="number">0x5D</span>, <span class="number">0xE8</span>, <span class="number">0xEA</span>, <span class="number">0xB5</span>, <span class="number">0x5A</span>, <span class="number">0x65</span>, <span class="number">0x88</span>, <span class="number">0xC5</span>, <span class="number">0x7F</span>, <span class="number">0x77</span>, <span class="number">0x11</span>, <span class="number">0xCF</span>, <span class="number">0xF1</span>, <span class="number">0x1B</span>, <span class="number">0x3F</span>, <span class="number">0xF4</span>, <span class="number">0x48</span>, <span class="number">0x47</span>, <span class="number">0x12</span>, <span class="number">0xE4</span>, <span class="number">0xBA</span>, <span class="number">0xDF</span>, <span class="number">0xE9</span>, <span class="number">0x62</span>, <span class="number">0x6E</span>, <span class="number">0xB4</span>, <span class="number">0x96</span>, <span class="number">0xCD</span>, <span class="number">0x13</span>, <span class="number">0x53</span>, <span class="number">0x4B</span>, <span class="number">0x28</span>, <span class="number">0xD7</span>, <span class="number">0xD1</span>, <span class="number">0x33</span>, <span class="number">0xB8</span>, <span class="number">0xE6</span>, <span class="number">0x7A</span>, <span class="number">0x2C</span>, <span class="number">0x9B</span>, <span class="number">0x29</span>, <span class="number">0x44</span>, <span class="number">0x52</span>, <span class="number">0xF7</span>, <span class="number">0x20</span>, <span class="number">0xF2</span>, <span class="number">0x31</span>, <span class="number">0xD3</span>, <span class="number">0xB9</span>, <span class="number">0x40</span>, <span class="number">0xD0</span>, <span class="number">0x34</span>, <span class="number">0xF5</span>, <span class="number">0x54</span>, <span class="number">0x1A</span>, <span class="number">0x01</span>, <span class="number">0xA1</span>, <span class="number">0x92</span>,</span><br><span class="line">        <span class="number">0xFC</span>, <span class="number">0x85</span>, <span class="number">0x07</span>, <span class="number">0xBE</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x19</span>, <span class="number">0xF3</span>, <span class="number">0x36</span>, <span class="number">0xF6</span>, <span class="number">0x72</span>, <span class="number">0x98</span>, <span class="number">0x4C</span>, <span class="number">0x7D</span>, <span class="number">0xC7</span>, <span class="number">0xD4</span>, <span class="number">0x45</span>, <span class="number">0x4A</span>, <span class="number">0x9A</span>, <span class="number">0xC3</span>, <span class="number">0x8A</span>, <span class="number">0xE5</span>, <span class="number">0x50</span>, <span class="number">0x46</span>, <span class="number">0xCC</span>, <span class="number">0x68</span>, <span class="number">0x76</span>, <span class="number">0x67</span>, <span class="number">0xC9</span>, <span class="number">0x0E</span>, <span class="number">0x3C</span>, <span class="number">0x57</span>, <span class="number">0xF0</span>, <span class="number">0x22</span>, <span class="number">0xBF</span>, <span class="number">0x26</span>, <span class="number">0x84</span>, <span class="number">0x0D</span>, <span class="number">0x90</span>, <span class="number">0xA3</span>, <span class="number">0xAE</span>, <span class="number">0x3D</span>, <span class="number">0x1D</span>, <span class="number">0xC8</span>, <span class="number">0x91</span>, <span class="number">0x05</span>, <span class="number">0x87</span>, <span class="number">0x70</span>, <span class="number">0x08</span>, <span class="number">0x73</span>, <span class="number">0x21</span>, <span class="number">0x49</span>, <span class="number">0x55</span>, <span class="number">0x3E</span>, <span class="number">0x37</span>, <span class="number">0x23</span>, <span class="number">0x18</span>, <span class="number">0x56</span>, <span class="number">0xCE</span>, <span class="number">0x82</span>, <span class="number">0x38</span>, <span class="number">0x95</span>, <span class="number">0x78</span>, <span class="number">0xF8</span>]</span><br><span class="line"></span><br><span class="line">crypto_table = <span class="built_in">dict</span>(<span class="built_in">zip</span>(s0_255,<span class="built_in">range</span>(<span class="number">0x100</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#get order table</span></span><br><span class="line">source = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;&#x27;</span></span><br><span class="line">replaced = <span class="string">&#x27;HfVl&#123;qPcCYNMoRi6D7Jr&#125;espOL3FhwdWAtTGZba4Ugjvnx1QkKE2IS9yuz5BX08m&#x27;</span></span><br><span class="line">revsere_table = [] <span class="comment">#index 是 source 在 replace 中的下标</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> source:</span><br><span class="line">    revsere_table.append(replaced.find(i))</span><br><span class="line"></span><br><span class="line">tmp = [<span class="number">0x52</span>, <span class="number">0xCB</span>, <span class="number">0x15</span>, <span class="number">0x10</span>, <span class="number">0x7E</span>, <span class="number">0xD3</span>, <span class="number">0x78</span>, <span class="number">0x26</span>, <span class="number">0xC2</span>, <span class="number">0x14</span>, <span class="number">0x09</span>, <span class="number">0x50</span>, <span class="number">0x55</span>, <span class="number">0xFA</span>, <span class="number">0xEE</span>, <span class="number">0xC3</span>, <span class="number">0x0A</span>, <span class="number">0x97</span>, <span class="number">0xB9</span>, <span class="number">0x38</span>, <span class="number">0x12</span>, <span class="number">0x3D</span>, <span class="number">0x0E</span>, <span class="number">0xE9</span>, <span class="number">0xBE</span>, <span class="number">0xF6</span>, <span class="number">0x2B</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0xA8</span>, <span class="number">0x87</span>, <span class="number">0xAE</span>, <span class="number">0x1D</span>, <span class="number">0x53</span>, <span class="number">0x62</span>, <span class="number">0xEC</span>, <span class="number">0xFC</span>, <span class="number">0x5C</span>, <span class="number">0x88</span>, <span class="number">0x68</span>, <span class="number">0x23</span>, <span class="number">0x5B</span>, <span class="number">0x36</span>, <span class="number">0x13</span>, <span class="number">0xFB</span>, <span class="number">0xD7</span>, <span class="number">0xCA</span>, <span class="number">0x7A</span>, <span class="number">0xBD</span>, <span class="number">0xD9</span>, <span class="number">0x69</span>, <span class="number">0x6A</span>, <span class="number">0xE4</span>, <span class="number">0x2A</span>, <span class="number">0x6C</span>, <span class="number">0x9D</span>, <span class="number">0x86</span>, <span class="number">0xE0</span>, <span class="number">0xA4</span>, <span class="number">0x01</span>, <span class="number">0xBA</span>, <span class="number">0x3B</span>, <span class="number">0x20</span>, <span class="number">0x92</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    tmp = decrypt(tmp, crypto_table)</span><br><span class="line">    tmp = reverse_order(tmp, revsere_table)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> tmp))</span><br><span class="line"><span class="comment"># 0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过以上脚本我们发现可以还原原来的明文</p>
<p>tmp是我们0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ{}整个流程加密后的数据动调就可以得到，这里是占时的值，因为后面还有加密的操作</p>
<p>然后利用字母对应表还原，(这个操作算是学到了呜呜呜tql3cly师傅)</p>
<p>下一步我们接着往下调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( v8 != <span class="number">256</span> );</span><br><span class="line">v65 = (<span class="type">void</span> *)alloc::raw_vec::RawVec$LT$T$C$A$GT$::allocate_in::h9362616e9151d1f3(<span class="number">255LL</span>, <span class="number">0LL</span>);</span><br><span class="line">v67 = v66;</span><br><span class="line"><span class="built_in">memcpy</span>(v65, sub_5625F9C2BB2B, <span class="number">0xFF</span>uLL);</span><br><span class="line">v81 = v65;</span><br><span class="line">v82 = v67;</span><br><span class="line">v83 = <span class="number">255LL</span>;</span><br><span class="line">alloc::vec::Vec$LT$T$C$A$GT$::resize::h7362553f00beaec8(&amp;v81, <span class="number">255LL</span>, <span class="number">0LL</span>);</span><br><span class="line"><span class="keyword">if</span> ( *(_DWORD *)(v85 + <span class="number">16</span>) == <span class="number">-1</span> )</span><br><span class="line">  core::panicking::panic::h65157a6ac7f1357a();</span><br><span class="line">v84 = v85 + <span class="number">16</span>;</span><br><span class="line">dest[<span class="number">0</span>] = xmmword_5625F9C29010;</span><br><span class="line">dest[<span class="number">1</span>] = xmmword_5625F9C29020;</span><br><span class="line">dest[<span class="number">2</span>] = xmmword_5625F9C29030;</span><br><span class="line">dest[<span class="number">3</span>] = xmmword_5625F9C29040;</span><br><span class="line">v68 = v83;</span><br><span class="line"><span class="keyword">if</span> ( v83 &lt; <span class="number">0xCD</span> )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_74;</span><br></pre></td></tr></table></figure>

<p>sub_5625F9C2BB2B  这个里面一开始是opcode，我们复制出来看下它的汇编</p>
<p>这里用了python的一个脚本，将指令还原汇编指令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> capstone</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disassemble_hex_instructions</span>(<span class="params">hex_instructions</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Create a Capstone engine</span></span><br><span class="line">        md = capstone.Cs(capstone.CS_ARCH_X86, capstone.CS_MODE_64)</span><br><span class="line">        instructions = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Convert the hexadecimal instructions to bytes</span></span><br><span class="line">        byte_data = <span class="built_in">bytes</span>(hex_instructions)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Disassemble each instruction</span></span><br><span class="line">        <span class="keyword">for</span> insn <span class="keyword">in</span> md.disasm(byte_data, <span class="number">0x1000</span>):</span><br><span class="line">            instructions.append(<span class="string">&quot;0x%x:\t%s\t%s&quot;</span> % (insn.address, insn.mnemonic, insn.op_str))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> capstone.CsError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Capstone Error: %s&quot;</span> % e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Input hexadecimal instructions</span></span><br><span class="line">    hex_instructions = [<span class="number">0x54</span>, <span class="number">0x5D</span>, <span class="number">0x31</span>, <span class="number">0xF6</span>, <span class="number">0x48</span>, <span class="number">0xB9</span>, <span class="number">0xA1</span>, <span class="number">0x57</span>, <span class="number">0x06</span>, <span class="number">0xB8</span>, <span class="number">0x62</span>, <span class="number">0x3A</span>, <span class="number">0x9F</span>, <span class="number">0x37</span>, <span class="number">0x48</span>, <span class="number">0xBA</span>, <span class="number">0x8E</span>, <span class="number">0x35</span>, <span class="number">0x6F</span>, <span class="number">0xD6</span>, <span class="number">0x4D</span>, <span class="number">0x49</span>, <span class="number">0xF7</span>, <span class="number">0x37</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xD1</span>, <span class="number">0x51</span>, <span class="number">0x54</span>, <span class="number">0x5F</span>, <span class="number">0x6A</span>, <span class="number">0x02</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x97</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x50</span>, <span class="number">0x54</span>, <span class="number">0x5E</span>, <span class="number">0x6A</span>, <span class="number">0x04</span>, <span class="number">0x5A</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x41</span>, <span class="number">0x5C</span>, <span class="number">0x6A</span>, <span class="number">0x03</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x31</span>, <span class="number">0xF6</span>, <span class="number">0x48</span>, <span class="number">0xB9</span>, <span class="number">0x3B</span>, <span class="number">0x3B</span>, <span class="number">0x6F</span>, <span class="number">0xC3</span>, <span class="number">0x63</span>, <span class="number">0x64</span>, <span class="number">0xC0</span>, <span class="number">0xAA</span>, <span class="number">0x48</span>, <span class="number">0xBA</span>, <span class="number">0x48</span>, <span class="number">0x4C</span>, <span class="number">0x0B</span>, <span class="number">0xC3</span>, <span class="number">0x63</span>, <span class="number">0x64</span>, <span class="number">0xC0</span>, <span class="number">0xAA</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xD1</span>, <span class="number">0x51</span>, <span class="number">0x48</span>, <span class="number">0xB9</span>, <span class="number">0x8C</span>, <span class="number">0x57</span>, <span class="number">0x82</span>, <span class="number">0x75</span>, <span class="number">0xD6</span>, <span class="number">0xF8</span>, <span class="number">0xA9</span>, <span class="number">0x7D</span>, <span class="number">0x48</span>, <span class="number">0xBA</span>, <span class="number">0xA3</span>, <span class="number">0x32</span>, <span class="number">0xF6</span>, <span class="number">0x16</span>, <span class="number">0xF9</span>, <span class="number">0x88</span>, <span class="number">0xC8</span>, <span class="number">0x0E</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xD1</span>, <span class="number">0x51</span>, <span class="number">0x54</span>, <span class="number">0x5F</span>, <span class="number">0x6A</span>, <span class="number">0x02</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x97</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x50</span>, <span class="number">0x54</span>, <span class="number">0x5E</span>, <span class="number">0x6A</span>, <span class="number">0x04</span>, <span class="number">0x5A</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x41</span>, <span class="number">0x5D</span>, <span class="number">0x6A</span>, <span class="number">0x03</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x31</span>, <span class="number">0xF6</span>, <span class="number">0x6A</span>, <span class="number">0x6F</span>, <span class="number">0x48</span>, <span class="number">0xB9</span>, <span class="number">0x59</span>, <span class="number">0xE5</span>, <span class="number">0x06</span>, <span class="number">0x0C</span>, <span class="number">0x2D</span>, <span class="number">0xF6</span>, <span class="number">0xD9</span>, <span class="number">0x77</span>, <span class="number">0x48</span>, <span class="number">0xBA</span>, <span class="number">0x76</span>, <span class="number">0x81</span>, <span class="number">0x63</span>, <span class="number">0x7A</span>, <span class="number">0x02</span>, <span class="number">0x8C</span>, <span class="number">0xBC</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xD1</span>, <span class="number">0x51</span>, <span class="number">0x54</span>, <span class="number">0x5F</span>, <span class="number">0x6A</span>, <span class="number">0x02</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x97</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x50</span>, <span class="number">0x54</span>, <span class="number">0x5E</span>, <span class="number">0x6A</span>, <span class="number">0x04</span>, <span class="number">0x5A</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x58</span>, <span class="number">0x48</span>, <span class="number">0xF7</span>, <span class="number">0xD0</span>, <span class="number">0x48</span>, <span class="number">0xC1</span>, <span class="number">0xE8</span>, <span class="number">0x1D</span>, <span class="number">0x48</span>, <span class="number">0x99</span>, <span class="number">0x6A</span>, <span class="number">0x29</span>, <span class="number">0x59</span>, <span class="number">0x48</span>, <span class="number">0xF7</span>, <span class="number">0xF1</span>, <span class="number">0x49</span>, <span class="number">0x96</span>, <span class="number">0x6A</span>, <span class="number">0x03</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0xB8</span>, <span class="number">0xEF</span>, <span class="number">0xBE</span>, <span class="number">0xAD</span>, <span class="number">0xDE</span>, <span class="number">0x44</span>, <span class="number">0x01</span>, <span class="number">0xE0</span>, <span class="number">0x44</span>, <span class="number">0x31</span>, <span class="number">0xE8</span>, <span class="number">0xC1</span>, <span class="number">0xC8</span>, <span class="number">0x0B</span>, <span class="number">0xF7</span>, <span class="number">0xD0</span>, <span class="number">0x44</span>, <span class="number">0x31</span>, <span class="number">0xF0</span>, <span class="number">0x3D</span>, <span class="number">0xEF</span>, <span class="number">0xBE</span>, <span class="number">0xAD</span>, <span class="number">0xDE</span>, <span class="number">0x75</span>, <span class="number">0x05</span>, <span class="number">0x6A</span>, <span class="number">0x01</span>, <span class="number">0x58</span>, <span class="number">0xEB</span>, <span class="number">0x03</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xC0</span>, <span class="number">0x50</span>, <span class="number">0x53</span>, <span class="number">0x5F</span>, <span class="number">0x54</span>, <span class="number">0x5E</span>, <span class="number">0x6A</span>, <span class="number">0x08</span>, <span class="number">0x5A</span>, <span class="number">0x6A</span>, <span class="number">0x01</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0x05</span>, <span class="number">0x55</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>]</span><br><span class="line">    disassembled_instructions = disassemble_hex_instructions(<span class="built_in">bytearray</span>(hex_instructions))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> disassembled_instructions:</span><br><span class="line">        <span class="keyword">for</span> instruction <span class="keyword">in</span> disassembled_instructions:</span><br><span class="line">            <span class="built_in">print</span>(instruction)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">assemble_call_instruction</span>(<span class="params">call_address</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ks = Ks(KS_ARCH_X86, KS_MODE_64)</span><br><span class="line">        call_instruction = <span class="string">f&quot;call <span class="subst">&#123;call_address:#X&#125;</span>&quot;</span></span><br><span class="line">        encoding, _ = ks.asm(call_instruction)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(encoding)</span><br><span class="line">    <span class="keyword">except</span> KsError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Keystone Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Address to call</span></span><br><span class="line">    call_address = <span class="number">0x0000559395BE3430</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Assemble the CALL instruction</span></span><br><span class="line">    assembled_instruction = assemble_call_instruction(call_address)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> assembled_instruction:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Assembled CALL instruction: <span class="subst">&#123;assembled_instruction.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>生成了如下汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">tconexp/hb.py</span><br><span class="line">0x1000: push    rsp</span><br><span class="line">0x1001: pop     rbp</span><br><span class="line">0x1002: xor     esi, esi</span><br><span class="line">0x1004: movabs  rcx, 0x379f3a62b80657a1</span><br><span class="line">0x100e: movabs  rdx, 0x37f7494dd66f358e</span><br><span class="line">0x1018: xor     rcx, rdx</span><br><span class="line">0x101b: push    rcx</span><br><span class="line">0x101c: push    rsp</span><br><span class="line">0x101d: pop     rdi</span><br><span class="line">0x101e: push    2</span><br><span class="line">0x1020: pop     rax</span><br><span class="line">0x1021: cdq</span><br><span class="line">0x1022: syscall</span><br><span class="line">0x1024: xchg    rdi, rax</span><br><span class="line">0x1026: xor     eax, eax</span><br><span class="line">0x1028: push    rax</span><br><span class="line">0x1029: push    rsp</span><br><span class="line">0x102a: pop     rsi</span><br><span class="line">0x102b: push    4</span><br><span class="line">0x102d: pop     rdx</span><br><span class="line">0x102e: syscall</span><br><span class="line">0x1030: pop     r12</span><br><span class="line">0x1032: push    3</span><br><span class="line">0x1034: pop     rax</span><br><span class="line">0x1035: syscall</span><br><span class="line">0x1037: xor     esi, esi</span><br><span class="line">0x1039: movabs  rcx, 0xaac06463c36f3b3b</span><br><span class="line">0x1043: movabs  rdx, 0xaac06463c30b4c48</span><br><span class="line">0x104d: xor     rcx, rdx</span><br><span class="line">0x1050: push    rcx</span><br><span class="line">0x1051: movabs  rcx, 0x7da9f8d67582578c</span><br><span class="line">0x105b: movabs  rdx, 0xec888f916f632a3</span><br><span class="line">0x1065: xor     rcx, rdx</span><br><span class="line">0x1068: push    rcx</span><br><span class="line">0x1069: push    rsp</span><br><span class="line">0x106a: pop     rdi</span><br><span class="line">0x106b: push    2</span><br><span class="line">0x106d: pop     rax</span><br><span class="line">0x106e: cdq</span><br><span class="line">0x106f: syscall</span><br><span class="line">0x1071: xchg    rdi, rax</span><br><span class="line">0x1073: xor     eax, eax</span><br><span class="line">0x1075: push    rax</span><br><span class="line">0x1076: push    rsp</span><br><span class="line">0x1077: pop     rsi</span><br><span class="line">0x1078: push    4</span><br><span class="line">0x107a: pop     rdx</span><br><span class="line">0x107b: syscall</span><br><span class="line">0x107d: pop     r13</span><br><span class="line">0x107f: push    3</span><br><span class="line">0x1081: pop     rax</span><br><span class="line">0x1082: syscall</span><br><span class="line">0x1084: xor     esi, esi</span><br><span class="line">0x1086: push    0x6f</span><br><span class="line">0x1088: movabs  rcx, 0x77d9f62d0c06e559</span><br><span class="line">0x1092: movabs  rdx, 0x5bc8c027a638176</span><br><span class="line">0x109c: xor     rcx, rdx</span><br><span class="line">0x109f: push    rcx</span><br><span class="line">0x10a0: push    rsp</span><br><span class="line">0x10a1: pop     rdi</span><br><span class="line">0x10a2: push    2</span><br><span class="line">0x10a4: pop     rax</span><br><span class="line">0x10a5: cdq</span><br><span class="line">0x10a6: syscall</span><br><span class="line">0x10a8: xchg    rdi, rax</span><br><span class="line">0x10aa: xor     eax, eax</span><br><span class="line">0x10ac: push    rax</span><br><span class="line">0x10ad: push    rsp</span><br><span class="line">0x10ae: pop     rsi</span><br><span class="line">0x10af: push    4</span><br><span class="line">0x10b1: pop     rdx</span><br><span class="line">0x10b2: syscall</span><br><span class="line">0x10b4: pop     rax</span><br><span class="line">0x10b5: not     rax</span><br><span class="line">0x10b8: shr     rax, 0x1d</span><br><span class="line">0x10bc: cqo</span><br><span class="line">0x10be: push    0x29</span><br><span class="line">0x10c0: pop     rcx</span><br><span class="line">0x10c1: div     rcx</span><br><span class="line">0x10c4: xchg    r14, rax</span><br><span class="line">0x10c6: push    3</span><br><span class="line">0x10c8: pop     rax</span><br><span class="line">0x10c9: syscall</span><br><span class="line">0x10cb: mov     eax, 0xdeadbeef</span><br><span class="line">0x10d0: add     eax, r12d</span><br><span class="line">0x10d3: xor     eax, r13d</span><br><span class="line">0x10d6: ror     eax, 0xb</span><br><span class="line">0x10d9: not     eax</span><br><span class="line">0x10db: xor     eax, r14d</span><br><span class="line">0x10de: cmp     eax, 0xdeadbeef</span><br><span class="line">0x10e3: jne     0x10ea</span><br><span class="line">0x10e5: push    1</span><br><span class="line">0x10e7: pop     rax</span><br><span class="line">0x10e8: jmp     0x10ed</span><br><span class="line">0x10ea: xor     rax, rax</span><br><span class="line">0x10ed: push    rax</span><br><span class="line">0x10ee: push    rbx</span><br><span class="line">0x10ef: pop     rdi</span><br><span class="line">0x10f0: push    rsp</span><br><span class="line">0x10f1: pop     rsi</span><br><span class="line">0x10f2: push    8</span><br><span class="line">0x10f4: pop     rdx</span><br><span class="line">0x10f5: push    1</span><br><span class="line">0x10f7: pop     rax</span><br><span class="line">0x10f8: syscall</span><br><span class="line">0x10fa: push    rbp</span><br><span class="line">0x10fb: pop     rsp</span><br></pre></td></tr></table></figure>

<p>目前发现没什么用先放这，继续往下动调，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v81 = v65;</span><br><span class="line"> v82 = v67;</span><br><span class="line"> v83 = <span class="number">255LL</span>;</span><br><span class="line"> alloc::vec::Vec$LT$T$C$A$GT$::resize::h7362553f00beaec8(&amp;v81, <span class="number">255LL</span>, <span class="number">0LL</span>);</span><br><span class="line"> <span class="keyword">if</span> ( *(_DWORD *)(v85 + <span class="number">16</span>) == <span class="number">-1</span> )</span><br><span class="line">   core::panicking::panic::h65157a6ac7f1357a();</span><br><span class="line"> v84 = v85 + <span class="number">16</span>;</span><br><span class="line"> dest[<span class="number">0</span>] = xmmword_5625F9C29010;</span><br><span class="line"> dest[<span class="number">1</span>] = xmmword_5625F9C29020;</span><br><span class="line"> dest[<span class="number">2</span>] = xmmword_5625F9C29030;</span><br><span class="line"> dest[<span class="number">3</span>] = xmmword_5625F9C29040;</span><br><span class="line"> v68 = v83;</span><br></pre></td></tr></table></figure>

<p>发现dest赋了新值，我们在这个代码执行完后面 的位置用ida patch到上面哪个shellcode位置</p>
<p>，发现这个位置改变了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x10cb: mov     eax, 0xxxxx  这个变成了我们输入的数据前4个byte</span><br><span class="line">0x10d0: add     eax, r12d</span><br><span class="line">0x10d3: xor     eax, r13d</span><br><span class="line">0x10d6: ror     eax, 0xb</span><br><span class="line">0x10d9: not     eax</span><br><span class="line">0x10db: xor     eax, r14d</span><br><span class="line">0x10de: cmp     eax, 0xxxxxx   这里变成了我们的dest数据也就是比较的目的数据</span><br></pre></td></tr></table></figure>

<p>嗯，分析这块关键代码我们发现这里进行了xor ror not xor操作，其中r12 r13 r14是未知的，所以我们要想办法获取这3个寄存器的值，我一开始想patch源程序到这个位置，发现到了这个位置就无法执行 了，所以使用另一种方法，就汇编写出asm文件，进行nasm编译，然后再动调把断点下在0x10cb就可以查看r12 13 14的值了</p>
<p>编译具体方法：</p>
<p>n.asm:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rbp</span><br><span class="line">    xor     esi, esi</span><br><span class="line">    mov     rcx, 0x379f3a62b80657a1</span><br><span class="line">    mov     rdx, 0x37f7494dd66f358e</span><br><span class="line">    xor     rcx, rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rdi</span><br><span class="line">    push    2</span><br><span class="line">    pop     rax</span><br><span class="line">    cdq</span><br><span class="line">    syscall</span><br><span class="line">    xchg    rdi, rax</span><br><span class="line">    xor     rax, rax</span><br><span class="line">    push    rax</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line">    push    4</span><br><span class="line">    pop     rdx</span><br><span class="line">    syscall</span><br><span class="line">    pop     r12</span><br><span class="line">    push    3</span><br><span class="line">    pop     rax</span><br><span class="line">    syscall</span><br><span class="line">    xor     esi, esi</span><br><span class="line">    mov     rcx, 0xaac06463c36f3b3b</span><br><span class="line">    mov     rdx, 0xaac06463c30b4c48</span><br><span class="line">    xor     rcx, rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    mov     rcx, 0x7da9f8d67582578c</span><br><span class="line">    mov     rdx, 0xec888f916f632a3</span><br><span class="line">    xor     rcx, rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rdi</span><br><span class="line">    push    2</span><br><span class="line">    pop     rax</span><br><span class="line">    cdq</span><br><span class="line">    syscall</span><br><span class="line">    xchg    rdi, rax</span><br><span class="line">    xor     rax, rax</span><br><span class="line">    push    rax</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line">    push    4</span><br><span class="line">    pop     rdx</span><br><span class="line">    syscall</span><br><span class="line">    pop     r13</span><br><span class="line">    push    3</span><br><span class="line">    pop     rax</span><br><span class="line">    syscall</span><br><span class="line">    xor     esi, esi</span><br><span class="line">    push    0x6f</span><br><span class="line">    mov     rcx, 0x77d9f62d0c06e559</span><br><span class="line">    mov     rdx, 0x5bc8c027a638176</span><br><span class="line">    xor     rcx, rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rdi</span><br><span class="line">    push    2</span><br><span class="line">    pop     rax</span><br><span class="line">    cdq</span><br><span class="line">    syscall</span><br><span class="line">    xchg    rdi, rax</span><br><span class="line">    xor     rax, rax</span><br><span class="line">    push    rax</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line">    push    4</span><br><span class="line">    pop     rdx</span><br><span class="line">    syscall</span><br><span class="line">    pop     rax</span><br><span class="line">    not     rax</span><br><span class="line">    shr     rax, 0x1d</span><br><span class="line">    cqo</span><br><span class="line">    push    0x29</span><br><span class="line">    pop     rcx</span><br><span class="line">    div     rcx</span><br><span class="line">    xchg    r14, rax</span><br><span class="line">    push    3</span><br><span class="line">    pop     rax</span><br><span class="line">    syscall</span><br><span class="line">    mov     eax, 0xdeadbeef</span><br><span class="line">    add     eax, r12d</span><br><span class="line">    xor     eax, r13d</span><br><span class="line">    ror     eax, 0xb</span><br><span class="line">    not     eax</span><br><span class="line">    xor     eax, r14d</span><br><span class="line">    cmp     eax, 0xdeadbeef</span><br><span class="line">    jne     short not_equal</span><br><span class="line">    push    1</span><br><span class="line">    pop     rax</span><br><span class="line">    jmp     short done</span><br><span class="line">not_equal:</span><br><span class="line">    xor     rax, rax</span><br><span class="line">done:</span><br><span class="line">    push    rax</span><br><span class="line">    push    rbx</span><br><span class="line">    pop     rdi</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line">    push    8</span><br><span class="line">    pop     rdx</span><br><span class="line">    push    1</span><br><span class="line">    pop     rax</span><br><span class="line">    syscall</span><br><span class="line">    push    rbp</span><br><span class="line">    pop     rsp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf64 -o vuln.o n.asm</span><br><span class="line">ld -o my_program vuln.o</span><br></pre></td></tr></table></figure>

<p>将上面的汇编进行编译生成elf文件，然后再使用ida动调得到如下</p>
<p>r12 &#x3D; 0x0000000464C457F    r13 &#x3D; 0x0000000746F6F72    r14 &#x3D; 0x000000031F3831F</p>
<p>分析完逻辑我们就可以写解密脚本了，参考3cly师傅的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data: <span class="built_in">list</span>, table: <span class="built_in">dict</span></span>):</span><br><span class="line">    tmp=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        tmp.append(table[i])</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_order</span>(<span class="params">data:<span class="built_in">list</span>, table: <span class="built_in">list</span></span>):</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        tmp.append(data[table[i]])</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def de_cmp(x):</span></span><br><span class="line"><span class="string">    r12 = 0x0000000464C457F</span></span><br><span class="line"><span class="string">    r13 = 0x0000000746F6F72</span></span><br><span class="line"><span class="string">    r14 = 0x000000031F3831F</span></span><br><span class="line"><span class="string">    x ^= r14</span></span><br><span class="line"><span class="string">    x = ~x</span></span><br><span class="line"><span class="string">    x = (x &lt;&lt; 11) | (x &gt;&gt; (32 - 11))</span></span><br><span class="line"><span class="string">    x ^= r13</span></span><br><span class="line"><span class="string">    x -= r12</span></span><br><span class="line"><span class="string">    print(hex(x))</span></span><br><span class="line"><span class="string">    return [x &amp; 0xff, (x &amp; 0xff00) &gt;&gt; 8, (x &amp; 0xff0000) &gt;&gt; 16, (x &amp; 0xff000000) &gt;&gt; 24]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de_cmp</span>(<span class="params">x</span>):</span><br><span class="line">    r12 = <span class="number">0x0000000464C457F</span></span><br><span class="line">    r13 = <span class="number">0x0000000746F6F72</span></span><br><span class="line">    r14 = <span class="number">0x000000031F3831F</span></span><br><span class="line"></span><br><span class="line">    x = np.uint32(x)</span><br><span class="line">    x = np.uint32(x ^ r14)</span><br><span class="line">    x = np.uint32(~x)</span><br><span class="line">    x = np.uint32((x &lt;&lt; <span class="number">11</span>) | (x &gt;&gt; (<span class="number">32</span> - <span class="number">11</span>)))</span><br><span class="line">    x = np.uint32(x ^ r13)</span><br><span class="line">    x = np.uint32(x - r12)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(x))</span><br><span class="line">    x = np.int32(x)</span><br><span class="line">    <span class="keyword">return</span> [x &amp; <span class="number">0xff</span>, (x &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>, (x &amp; <span class="number">0xff0000</span>) &gt;&gt; <span class="number">16</span>, (x &amp; <span class="number">0xff000000</span>) &gt;&gt; <span class="number">24</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># get crypto table</span></span><br><span class="line">s0_255 = [<span class="number">0xFB</span>, <span class="number">0x7B</span>, <span class="number">0x4E</span>, <span class="number">0xBB</span>, <span class="number">0x51</span>, <span class="number">0x15</span>, <span class="number">0x8D</span>, <span class="number">0xDB</span>, <span class="number">0xB0</span>, <span class="number">0xAC</span>, <span class="number">0xA5</span>, <span class="number">0x8E</span>, <span class="number">0xAA</span>, <span class="number">0xB2</span>, <span class="number">0x60</span>, <span class="number">0xEB</span>, <span class="number">0x63</span>, <span class="number">0x5C</span>, <span class="number">0xDE</span>, <span class="number">0x42</span>, <span class="number">0x2B</span>, <span class="number">0xC6</span>, <span class="number">0xA6</span>, <span class="number">0x35</span>, <span class="number">0x30</span>, <span class="number">0x43</span>, <span class="number">0xD6</span>, <span class="number">0x5F</span>, <span class="number">0xBD</span>, <span class="number">0x24</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>, <span class="number">0x8C</span>, <span class="number">0xA7</span>, <span class="number">0xD5</span>, <span class="number">0x2A</span>, <span class="number">0x7C</span>, <span class="number">0x6D</span>, <span class="number">0x8B</span>, <span class="number">0x17</span>, <span class="number">0x9D</span>, <span class="number">0x83</span>, <span class="number">0xFE</span>, <span class="number">0x69</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0xA9</span>, <span class="number">0x9E</span>, <span class="number">0x0F</span>, <span class="number">0x1C</span>, <span class="number">0x66</span>, <span class="number">0x97</span>, <span class="number">0x5B</span>, <span class="number">0x61</span>, <span class="number">0xED</span>, <span class="number">0xAD</span>, <span class="number">0xE0</span>, <span class="number">0xDA</span>, <span class="number">0x27</span>, <span class="number">0x06</span>, <span class="number">0x25</span>, <span class="number">0xDC</span>, <span class="number">0x5E</span>, <span class="number">0xE7</span>,</span><br><span class="line">        <span class="number">0x41</span>, <span class="number">0x32</span>, <span class="number">0xD2</span>, <span class="number">0xD9</span>, <span class="number">0x8F</span>, <span class="number">0xEE</span>, <span class="number">0xAF</span>, <span class="number">0x03</span>, <span class="number">0x93</span>, <span class="number">0x3A</span>, <span class="number">0x00</span>, <span class="number">0xA2</span>, <span class="number">0xE1</span>, <span class="number">0xB3</span>, <span class="number">0xEC</span>, <span class="number">0x81</span>, <span class="number">0x9F</span>, <span class="number">0xCA</span>, <span class="number">0x58</span>, <span class="number">0xB7</span>, <span class="number">0x79</span>, <span class="number">0xFD</span>, <span class="number">0x3B</span>, <span class="number">0xA0</span>, <span class="number">0x02</span>, <span class="number">0x0C</span>, <span class="number">0xCB</span>, <span class="number">0xA8</span>, <span class="number">0x80</span>, <span class="number">0xC0</span>, <span class="number">0x16</span>, <span class="number">0x4D</span>, <span class="number">0x2F</span>, <span class="number">0x75</span>, <span class="number">0x71</span>, <span class="number">0x0A</span>, <span class="number">0x04</span>, <span class="number">0x39</span>, <span class="number">0xFF</span>, <span class="number">0xC1</span>, <span class="number">0x9C</span>, <span class="number">0xAB</span>, <span class="number">0xEF</span>, <span class="number">0xA4</span>, <span class="number">0xD8</span>, <span class="number">0xE2</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x6C</span>, <span class="number">0x64</span>, <span class="number">0x1E</span>, <span class="number">0x6B</span>, <span class="number">0x7E</span>, <span class="number">0x99</span>, <span class="number">0x2E</span>, <span class="number">0x09</span>, <span class="number">0x0B</span>, <span class="number">0x86</span>, <span class="number">0x74</span>, <span class="number">0x6A</span>, <span class="number">0xC4</span>, <span class="number">0x2D</span>, <span class="number">0x4F</span>, <span class="number">0xF9</span>,</span><br><span class="line">        <span class="number">0xFA</span>, <span class="number">0x94</span>, <span class="number">0xB6</span>, <span class="number">0x1F</span>, <span class="number">0x89</span>, <span class="number">0x6F</span>, <span class="number">0x5D</span>, <span class="number">0xE8</span>, <span class="number">0xEA</span>, <span class="number">0xB5</span>, <span class="number">0x5A</span>, <span class="number">0x65</span>, <span class="number">0x88</span>, <span class="number">0xC5</span>, <span class="number">0x7F</span>, <span class="number">0x77</span>, <span class="number">0x11</span>, <span class="number">0xCF</span>, <span class="number">0xF1</span>, <span class="number">0x1B</span>, <span class="number">0x3F</span>, <span class="number">0xF4</span>, <span class="number">0x48</span>, <span class="number">0x47</span>, <span class="number">0x12</span>, <span class="number">0xE4</span>, <span class="number">0xBA</span>, <span class="number">0xDF</span>, <span class="number">0xE9</span>, <span class="number">0x62</span>, <span class="number">0x6E</span>, <span class="number">0xB4</span>, <span class="number">0x96</span>, <span class="number">0xCD</span>, <span class="number">0x13</span>, <span class="number">0x53</span>, <span class="number">0x4B</span>, <span class="number">0x28</span>, <span class="number">0xD7</span>, <span class="number">0xD1</span>, <span class="number">0x33</span>, <span class="number">0xB8</span>, <span class="number">0xE6</span>, <span class="number">0x7A</span>, <span class="number">0x2C</span>, <span class="number">0x9B</span>, <span class="number">0x29</span>, <span class="number">0x44</span>, <span class="number">0x52</span>, <span class="number">0xF7</span>, <span class="number">0x20</span>, <span class="number">0xF2</span>, <span class="number">0x31</span>, <span class="number">0xD3</span>, <span class="number">0xB9</span>, <span class="number">0x40</span>, <span class="number">0xD0</span>, <span class="number">0x34</span>, <span class="number">0xF5</span>, <span class="number">0x54</span>, <span class="number">0x1A</span>, <span class="number">0x01</span>, <span class="number">0xA1</span>, <span class="number">0x92</span>,</span><br><span class="line">        <span class="number">0xFC</span>, <span class="number">0x85</span>, <span class="number">0x07</span>, <span class="number">0xBE</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x19</span>, <span class="number">0xF3</span>, <span class="number">0x36</span>, <span class="number">0xF6</span>, <span class="number">0x72</span>, <span class="number">0x98</span>, <span class="number">0x4C</span>, <span class="number">0x7D</span>, <span class="number">0xC7</span>, <span class="number">0xD4</span>, <span class="number">0x45</span>, <span class="number">0x4A</span>, <span class="number">0x9A</span>, <span class="number">0xC3</span>, <span class="number">0x8A</span>, <span class="number">0xE5</span>, <span class="number">0x50</span>, <span class="number">0x46</span>, <span class="number">0xCC</span>, <span class="number">0x68</span>, <span class="number">0x76</span>, <span class="number">0x67</span>, <span class="number">0xC9</span>, <span class="number">0x0E</span>, <span class="number">0x3C</span>, <span class="number">0x57</span>, <span class="number">0xF0</span>, <span class="number">0x22</span>, <span class="number">0xBF</span>, <span class="number">0x26</span>, <span class="number">0x84</span>, <span class="number">0x0D</span>, <span class="number">0x90</span>, <span class="number">0xA3</span>, <span class="number">0xAE</span>, <span class="number">0x3D</span>, <span class="number">0x1D</span>, <span class="number">0xC8</span>, <span class="number">0x91</span>, <span class="number">0x05</span>, <span class="number">0x87</span>, <span class="number">0x70</span>, <span class="number">0x08</span>, <span class="number">0x73</span>, <span class="number">0x21</span>, <span class="number">0x49</span>, <span class="number">0x55</span>, <span class="number">0x3E</span>, <span class="number">0x37</span>, <span class="number">0x23</span>, <span class="number">0x18</span>, <span class="number">0x56</span>, <span class="number">0xCE</span>, <span class="number">0x82</span>, <span class="number">0x38</span>, <span class="number">0x95</span>, <span class="number">0x78</span>, <span class="number">0xF8</span>]</span><br><span class="line"></span><br><span class="line">crypto_table = <span class="built_in">dict</span>(<span class="built_in">zip</span>(s0_255,<span class="built_in">range</span>(<span class="number">0x100</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#get order table</span></span><br><span class="line">source = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;&#x27;</span></span><br><span class="line">replaced = <span class="string">&#x27;HfVl&#123;qPcCYNMoRi6D7Jr&#125;espOL3FhwdWAtTGZba4Ugjvnx1QkKE2IS9yuz5BX08m&#x27;</span></span><br><span class="line">revsere_table = [] <span class="comment">#index是source在replace中的下标</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> source:</span><br><span class="line">    revsere_table.append(replaced.find(i))</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(crypto_table)</span></span><br><span class="line"><span class="comment">#print(revsere_table)</span></span><br><span class="line"></span><br><span class="line">cmp_data = [<span class="number">0x526851A7</span>, <span class="number">0x31FF2785</span>, <span class="number">0xC7D28788</span>, <span class="number">0x523F23D3</span>, <span class="number">0xAF1F1055</span>, <span class="number">0x5C94F027</span>, <span class="number">0x797A3FCD</span>, <span class="number">0xE7F02F9F</span>, <span class="number">0x3C86F045</span>, <span class="number">0x6DEAB0F9</span>, <span class="number">0x91F74290</span>, <span class="number">0x7C9A3AED</span>, <span class="number">0xDC846B01</span>, <span class="number">0x0743C86C</span>, <span class="number">0xDFF7085C</span>, <span class="number">0xA4AEE3EB</span>]</span><br><span class="line"></span><br><span class="line">tmp = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cmp_data:</span><br><span class="line">    tmp+=de_cmp(i)</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    tmp = decrypt(tmp, crypto_table)</span><br><span class="line">    tmp = reverse_order(tmp, revsere_table)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> tmp))</span><br></pre></td></tr></table></figure>

<p>cmp_data直接提取dest数据就可以了，因为比较数据是固定的</p>
<p>总结：这道题学到了不少，学到了flag换位加密用固定表紧跟着第二次加密（64），在第二次加密的时候输入的字符和代码行为没有任何关系，所以采用了映射字母表查询（第一次用到这个方法）</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Mr. Jsjsj, licensed under <a href="https://jsjsj.top/">Jsjsj blog</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Reverse/" class="tag">#Reverse</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/05/01/%E6%AF%8F%E5%91%A8%E5%AD%A6%E4%B9%A0%E5%91%A8%E8%AE%B0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">每周学习周记</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/10/05/V8escape%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">V8 escape环境搭建(一)</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="MrWillCom/MrWillCom.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyODg5NTc5MTA=" data-category="Announcements" data-category-id="DIC_kwDOETkl1s4COQZm" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/jsjsj1" class="item">GitHub</a>
                
                <a href="904815041@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2023 Mr. Jsjsj<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
         
        
<script src="//code.tidio.co/6bkvqlfpdbtihnufei8yxpsvf98bq5gv.js"></script>
 
        
<script src="/js/tidio.js"></script>

        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>